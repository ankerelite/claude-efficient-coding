import React,{useState,useEffect,useRef,useCallback}from'react';import{Card,CardContent}from'@/components/ui/card';import{Button}from'@/components/ui/button';import{Trophy,X,Diamond}from'lucide-react';const G={U:[{i:'c',n:'Cart',c:15,v:.1,m:100},{i:'d',n:'Drill',c:100,v:1,m:50},{i:'r',n:'Robot',c:1100,v:8,m:25},{i:'e',n:'Excavator',c:12000,v:47,m:10}],T:[{t:'Ruby',c:'#E31837',w:.4,s:[4,6],p:.2},{t:'Sapphire',c:'#0F52BA',w:.3,s:[5,8],p:.4},{t:'Emerald',c:'#50C878',w:.2,s:[6,10],p:.6},{t:'Diamond',c:'#A5F2F3',w:.1,s:[8,12],p:.8}]};class P{constructor(x,y,t='c'){this.x=x;this.y=y;this.t=t;this.l=1;this.vy=-(Math.random()*4+3);this.vx=(Math.random()-.5)*8;this.a=Math.random()*Math.PI*2;this.r=(Math.random()-.5)*.4;this.f=.01;this.s=1+Math.random()*.8}u(){this.vy+=.2;this.y+=this.vy;this.x+=this.vx;this.vx*=.99;this.a+=this.r;this.l-=this.f;return this.l>0}d(c){if(this.l<=0)return!1;c.save();c.translate(this.x,this.y);c.rotate(this.a);c.scale(this.s,this.s);if(this.t==='c'){c.beginPath();c.ellipse(0,0,4.5,4.5*Math.abs(Math.cos(this.a)),0,0,Math.PI*2);c.fillStyle=`rgba(255,215,0,${this.l})`;c.strokeStyle=`rgba(218,165,32,${this.l})`;c.lineWidth=.5;c.fill();c.stroke()}else{c.beginPath();for(let i=0;i<5;i++){const a=(i*Math.PI*2)/5;const o=8,n=3;const x=Math.cos(a-Math.PI/2)*o;const y=Math.sin(a-Math.PI/2)*o;const X=Math.cos(a+Math.PI/5-Math.PI/2)*n;const Y=Math.sin(a+Math.PI/5-Math.PI/2)*n;i===0?c.moveTo(x,y):c.lineTo(x,y);c.lineTo(X,Y)}c.closePath();c.fillStyle=`rgba(255,255,255,${this.l*.8})`;c.fill()}c.restore();return!0}}class M{constructor(x,y,p=1){const r=Math.random();let t=0,w=0;for(let i=0;i<G.T.length;i++){w+=G.T[i].w;if(r<w){t=i;break}}const T=G.T[t];this.x=x;this.y=y;this.vy=0;this.vx=(Math.random()-.5)*2;this.z=T.s[0]+Math.random()*(T.s[1]-T.s[0]);this.z*=Math.min(1+(Math.log10(p)/10),2);this.a=Math.random()*Math.PI*2;this.r=(Math.random()-.5)*.1;this.c=T.c;this.t=T.t;this.p=Math.random()<T.p;this.s=0;this.o=1}u(h,w){if(this.s){if(!this.p){this.o-=.01;return this.o>0}return!0}this.vy+=.4;this.y+=this.vy;this.x+=this.vx;this.vx*=.98;this.a+=this.r;if(this.y+this.z>h-50){this.y=h-50-this.z;if(Math.abs(this.vy)<.8){this.s=1;return!0}this.vy*=-.6;this.vx*=.7}return!0}d(c){c.save();c.translate(this.x,this.y);c.rotate(this.a);c.globalAlpha=this.o;c.beginPath();for(let i=0;i<6;i++){const a=(i*Math.PI)/3,x=this.z*Math.cos(a),y=this.z*Math.sin(a);i===0?c.moveTo(x,y):c.lineTo(x,y)}c.closePath();c.fillStyle=this.c;c.shadowBlur=4;c.shadowColor='rgba(255,255,255,0.3)';c.fill();c.restore()}}const GC=({g,s,t})=>{if(!s.d)return(<Card className="bg-purple-900/30 border border-purple-700/30"><CardContent className="p-4"><div className="flex items-center justify-center h-24"><span className="text-gray-500">???</span></div></CardContent></Card>);const r=t>0?(s.t/t*100):0;const rt=r<1?'Legendary':r<5?'Epic':r<15?'Rare':r<30?'Uncommon':'Common';const rc=r<1?'text-yellow-300':r<5?'text-purple-300':r<15?'text-blue-300':r<30?'text-green-300':'text-gray-300';return(<Card className="bg-purple-900/50"><CardContent className="p-4"><div className="flex justify-between items-start"><div><h3 className="font-bold text-lg">{g.t}</h3><p className={`text-sm ${rc}`}>{rt}</p></div><div className="w-6 h-6 rounded-full"style={{backgroundColor:g.c}}/></div><div className="mt-2 space-y-1 text-sm"><div className="flex justify-between"><span>Found:</span><span>{s.t}</span></div><div className="flex justify-between"><span>Largest:</span><span>{s.l.toFixed(1)}</span></div><div className="mt-2"><div className="w-full bg-purple-900/50 rounded-full h-1"><div className={`rounded-full h-1 transition-all duration-500 ${r<1?'bg-yellow-300':r<5?'bg-purple-300':r<15?'bg-blue-300':r<30?'bg-green-300':'bg-gray-300'}`}style={{width:`${Math.min(r*2,100)}%`}}/></div></div></div></CardContent></Card>)};export default function D(){const[s,S]=useState({g:0,p:0,n:[],c:G.T.reduce((a,t)=>({...a,[t.t]:{d:false,t:0,l:0}}),{}),u:G.U.reduce((a,u)=>({...a,[u.i]:{n:0,c:u.c}}),{})}),[v,V]=useState(false),R=useRef(null),B=useRef(null),p=useRef([]),m=useRef([]),[z,Z]=useState({}),t=useRef(0);useEffect(()=>{const c=R.current,b=B.current;if(!c||!b)return;const x=c.getContext('2d'),y=b.getContext('2d');let f;const r=()=>{const w=window.innerWidth,h=window.innerHeight;c.width=w;c.height=h;b.width=w;b.height=h;Z({w,h})};const a=()=>{x.clearRect(0,0,c.width,c.height);y.clearRect(0,0,b.width,b.height);p.current=p.current.filter(p=>p.u()&&p.d(x));const g=m.current.filter(g=>g.s?(g.d(y),g.u(c.height,c.width)):(g.d(x),g.u(c.height,c.width)));m.current=g.slice(-100);f=requestAnimationFrame(a)};r();window.addEventListener('resize',r);f=requestAnimationFrame(a);return()=>{window.removeEventListener('resize',r);cancelAnimationFrame(f)}},[]);const h=useCallback((e)=>{if(!z.w)return;const r=R.current.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;p.current=[...p.current,...Array(12).fill().map(()=>new P(x,y,'c')),...Array(5).fill().map(()=>new P(x,y,'s'))].slice(-100);const g=new M(x,-20,s.p);g.y=y-50;g.vy=-5;m.current=[...m.current,g].slice(-50);S(p=>({...p,g:p.g+1,c:{...p.c,[g.t]:{d:true,t:p.c[g.t].t+1,l:Math.max(p.c[g.t].l,g.z)}}}))},[z.w,s.p]);useEffect(()=>{if(!z.w||s.p<=0)return;const i=setInterval(()=>{const n=Date.now(),d=n-t.current,b=Math.min(Math.log10(1+s.p),5)/10;if(d>100&&Math.random()<b){const g=new M(Math.random()*(z.w-40)+20,-20,s.p);m.current=[...m.current,g].slice(-100);t.current=n}S(p=>({...p,g:p.g+p.p*.1}))},100);return()=>clearInterval(i)},[z.w,s.p]);const b=useCallback(i=>{S(p=>{const u=p.u[i],b=G.U.find(u=>u.i===i);if(p.g<u.c||u.n>=b.m)return p;const n=u.n+1,N={...p,g:p.g-u.c,p:p.p+b.v,u:{...p.u,[i]:{n,c:Math.floor(b.c*Math.pow(1.15,n))}}};if(n===1)N.n=[...p.n,{t:Date.now(),m:`First ${b.n}!`}];return N})},[]);const tg=Object.values(s.c).reduce((s,c)=>s+c.t,0);return(<div className="min-h-screen bg-purple-900"><Button onClick={()=>V(true)}className="fixed top-4 left-4 z-50 bg-blue-600 hover:bg-blue-700"><Diamond className="w-4 h-4 mr-2"/>Collection</Button>{v&&<div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><Card className="w-full max-w-2xl bg-purple-800/90 backdrop-blur-sm text-white"><CardContent className="p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold flex items-center"><Diamond className="w-6 h-6 mr-2"/>Gem Collection</h2><Button onClick={()=>V(false)}variant="ghost"className="hover:bg-purple-700/50"><X className="w-4 h-4"/></Button></div><div className="grid grid-cols-2 gap-4">{G.T.map(g=><GC key={g.t}g={g}s={s.c[g.t]}t={tg}/>)}</div></CardContent></Card></div>}<div className="fixed top-4 right-4 z-50 space-y-2">{s.n.map(n=><div key={n.t}className="bg-yellow-600/90 text-white p-3 rounded-lg shadow-lg">{n.m}</div>)}</div><div className="fixed inset-0 select-none"style={{width:'100vw',height:'100vh'}}><canvas ref={B}className="absolute inset-0"style={{width:'100%',height:'100%'}}/><canvas ref={R}className="absolute inset-0 cursor-pointer"style={{width:'100%',height:'100%'}}onClick={h}/></div><div className="relative z-10 p-4"><div className="max-w-2xl mx-auto space-y-4"><Card className="bg-purple-800/70 backdrop-blur-sm text-white"><CardContent className="p-4 text-center"><div className="text-3xl font-bold">{Math.floor(s.g)} Gems</div><div className="text-sm">Production: {s.p.toFixed(1)}/s</div></CardContent></Card>{G.U.map(u=>{const c=s.u[u.i];return(<Card key={u.i}className="bg-purple-800/70 backdrop-blur-sm text-white"><CardContent className="p-4"><div className="flex justify-between items-center"><div><h3 className="font-bold">{u.n}</h3><p className="text-sm">Owned: {c.n} / {u.m}</p><p className="text-xs">Produces: {u.v}/s</p></div><Button onClick={()=>b(u.i)}disabled={s.g<c.c}className="bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400">Buy: {Math.floor(c.c)}</Button></div></CardContent></Card>)})}</div></div></div>)}
